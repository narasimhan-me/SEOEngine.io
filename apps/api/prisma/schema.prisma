// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// User roles for access control
enum UserRole {
  USER
  ADMIN
}

// Supported ecommerce platform integration types
enum IntegrationType {
  SHOPIFY
  WOOCOMMERCE
  BIGCOMMERCE
  MAGENTO
  CUSTOM_WEBSITE
}

enum CrawlFrequency {
  DAILY
  WEEKLY
  MONTHLY
}

enum AutomationTargetType {
  PRODUCT
  PAGE
}

enum AutomationIssueType {
  MISSING_METADATA
  THIN_CONTENT
}

model User {
  id               String   @id @default(cuid())
  email            String   @unique
  password         String
  name             String?
  role             UserRole @default(USER)
  twoFactorEnabled Boolean  @default(false)
  twoFactorSecret  String?  // Base32-encoded TOTP secret
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  projects     Project[]
  subscription Subscription?
  aiUsageEvents AiUsageEvent[]
}

model Project {
  id                         String             @id @default(cuid())
  user                       User               @relation(fields: [userId], references: [id])
  userId                     String
  name                       String
  domain                     String?
  createdAt                  DateTime           @default(now())
  currentDeoScore            Int?
  currentDeoScoreComputedAt  DateTime?
  lastCrawledAt              DateTime?
  lastDeoComputedAt          DateTime?
  autoCrawlEnabled           Boolean            @default(true)
  crawlFrequency             CrawlFrequency     @default(DAILY)
  autoSuggestMissingMetadata Boolean            @default(false)
  autoSuggestThinContent     Boolean            @default(false)
  autoSuggestDailyCap        Int                @default(50)

  integrations               Integration[]
  crawlResults               CrawlResult[]
  products                   Product[]
  deoScoreSnapshots          DeoScoreSnapshot[]
  automationSuggestions      AutomationSuggestion[]
  aiUsageEvents              AiUsageEvent[]
}

model Integration {
  id          String          @id @default(cuid())
  project     Project         @relation(fields: [projectId], references: [id])
  projectId   String
  type        IntegrationType
  externalId  String?         // shop domain, store ID, account slug, etc.
  accessToken String?         // shopify token, woo API key, etc.
  config      Json?           // platform-specific configuration
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  @@unique([projectId, type]) // One integration per type per project
}

model Product {
  id             String   @id @default(cuid())
  project        Project  @relation(fields: [projectId], references: [id])
  projectId      String
  externalId     String   // platform-agnostic ID (was shopifyId)
  title          String
  description    String?
  seoTitle       String?
  seoDescription String?
  imageUrls      Json?
  lastSyncedAt   DateTime @default(now())
}

model CrawlResult {
  id              String   @id @default(cuid())
  project         Project  @relation(fields: [projectId], references: [id])
  projectId       String
  url             String
  statusCode      Int
  title           String?
  metaDescription String?
  h1              String?
  wordCount       Int?
  loadTimeMs      Int?
  issues          Json
  scannedAt       DateTime @default(now())
}

model AutomationSuggestion {
  id                   String               @id @default(cuid())
  project              Project              @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId            String
  targetType           AutomationTargetType
  targetId             String
  issueType            AutomationIssueType
  suggestedTitle       String?
  suggestedDescription String?
  suggestedH1          String?
  generatedAt          DateTime             @default(now())
  source               String               @default("automation_v1")
  applied              Boolean              @default(false)
  appliedAt            DateTime?

  @@unique([projectId, targetType, targetId, issueType])
}

model Subscription {
  id                   String    @id @default(cuid())
  user                 User      @relation(fields: [userId], references: [id])
  userId               String    @unique // One subscription per user
  plan                 String    // e.g., "free", "starter", "pro", "enterprise"
  stripeCustomerId     String?
  stripeSubscriptionId String?
  status               String    @default("active") // active, canceled, past_due, etc.
  currentPeriodStart   DateTime?
  currentPeriodEnd     DateTime?
  lastStripeEventId    String?   // idempotency guard for Stripe webhooks
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
}

model DeoScoreSnapshot {
  id              String   @id @default(cuid())
  project         Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId       String
  overallScore    Int
  contentScore    Int?
  entityScore     Int?
  technicalScore  Int?
  visibilityScore Int?
  version         String   @default("v1")
  metadata        Json?
  computedAt      DateTime @default(now())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([projectId, computedAt(sort: Desc)])
}

model AiUsageEvent {
  id        String   @id @default(cuid())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId String
  feature   String
  createdAt DateTime @default(now())

  @@index([userId, feature, createdAt])
  @@index([projectId, feature, createdAt])
}

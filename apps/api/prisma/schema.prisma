// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// User roles for access control
enum UserRole {
  USER
  ADMIN
}

// Supported ecommerce platform integration types
enum IntegrationType {
  SHOPIFY
  WOOCOMMERCE
  BIGCOMMERCE
  MAGENTO
  CUSTOM_WEBSITE
}

enum CrawlFrequency {
  DAILY
  WEEKLY
  MONTHLY
}

enum AutomationTargetType {
  PRODUCT
  PAGE
}

enum AutomationIssueType {
  MISSING_METADATA
  THIN_CONTENT
}

enum AutomationPlaybookDraftStatus {
  READY
  PARTIAL
  FAILED
  EXPIRED
}

enum AutomationPlaybookRunType {
  PREVIEW_GENERATE
  DRAFT_GENERATE
  APPLY
  INTENT_FIX_PREVIEW  // SEARCH-INTENT-1: Intent fix preview generation
}

enum AutomationPlaybookRunStatus {
  QUEUED
  RUNNING
  SUCCEEDED
  FAILED
  CANCELLED
  STALE
}

model User {
  id               String   @id @default(cuid())
  email            String   @unique
  password         String
  name             String?
  role             UserRole @default(USER)
  twoFactorEnabled Boolean  @default(false)
  twoFactorSecret  String?  // Base32-encoded TOTP secret
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  projects     Project[]
  subscription Subscription?
  aiUsageEvents AiUsageEvent[]
  automationPlaybookRuns AutomationPlaybookRun[]
  intentFixApplications ProductIntentFixApplication[]
}

model Project {
  id                         String             @id @default(cuid())
  user                       User               @relation(fields: [userId], references: [id])
  userId                     String
  name                       String
  domain                     String?
  createdAt                  DateTime           @default(now())
  currentDeoScore            Int?
  currentDeoScoreComputedAt  DateTime?
  lastCrawledAt              DateTime?
  lastDeoComputedAt          DateTime?
  autoCrawlEnabled           Boolean            @default(true)
  crawlFrequency             CrawlFrequency     @default(DAILY)
  autoSuggestMissingMetadata Boolean            @default(false)
  autoSuggestThinContent     Boolean            @default(false)
  autoSuggestDailyCap        Int                @default(50)

  aeoSyncToShopifyMetafields Boolean            @default(false)

  integrations               Integration[]
  crawlResults               CrawlResult[]
  products                   Product[]
  deoScoreSnapshots          DeoScoreSnapshot[]
  automationSuggestions      AutomationSuggestion[]
  automationPlaybookDrafts   AutomationPlaybookDraft[]
  aiUsageEvents              AiUsageEvent[]
  automationPlaybookRuns     AutomationPlaybookRun[]
}

model Integration {
  id          String          @id @default(cuid())
  project     Project         @relation(fields: [projectId], references: [id])
  projectId   String
  type        IntegrationType
  externalId  String?         // shop domain, store ID, account slug, etc.
  accessToken String?         // shopify token, woo API key, etc.
  config      Json?           // platform-specific configuration
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  @@unique([projectId, type]) // One integration per type per project
}

model Product {
  id             String   @id @default(cuid())
  project        Project  @relation(fields: [projectId], references: [id])
  projectId      String
  externalId     String   // platform-agnostic ID (was shopifyId)
  title          String
  description    String?
  seoTitle       String?
  seoDescription String?
  imageUrls      Json?
  lastSyncedAt   DateTime @default(now())

  answerBlocks         AnswerBlock[]
  intentCoverages      ProductIntentCoverage[]
  intentFixDrafts      ProductIntentFixDraft[]
  intentFixApplications ProductIntentFixApplication[]
}

model AnswerBlock {
  id               String   @id @default(cuid())
  product          Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId        String
  questionId       String
  questionText     String
  answerText       String
  confidenceScore  Float
  sourceType       String   @default("generated")
  sourceFieldsUsed String[] @default([])
  version          String   @default("ae_v1")
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@unique([productId, questionId])
  @@index([productId])
}

model AnswerBlockAutomationLog {
  id               String   @id @default(cuid())
  projectId        String
  productId        String
  triggerType      String
  planId           String
  action           String
  beforeAnswerBlocks Json?
  afterAnswerBlocks  Json?
  status           String   // succeeded | failed | skipped
  errorMessage     String?
  modelUsed        String?
  tokenEstimate    Int?
  createdAt        DateTime @default(now())

  @@index([projectId, productId, createdAt])
}

model CrawlResult {
  id              String   @id @default(cuid())
  project         Project  @relation(fields: [projectId], references: [id])
  projectId       String
  url             String
  statusCode      Int
  title           String?
  metaDescription String?
  h1              String?
  wordCount       Int?
  loadTimeMs      Int?
  issues          Json
  scannedAt       DateTime @default(now())
}

model AutomationSuggestion {
  id                   String               @id @default(cuid())
  project              Project              @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId            String
  targetType           AutomationTargetType
  targetId             String
  issueType            AutomationIssueType
  suggestedTitle       String?
  suggestedDescription String?
  suggestedH1          String?
  generatedAt          DateTime             @default(now())
  source               String               @default("automation_v1")
  applied              Boolean              @default(false)
  appliedAt            DateTime?

  @@unique([projectId, targetType, targetId, issueType])
}

model Subscription {
  id                   String    @id @default(cuid())
  user                 User      @relation(fields: [userId], references: [id])
  userId               String    @unique // One subscription per user
  plan                 String    // e.g., "free", "starter", "pro", "enterprise"
  stripeCustomerId     String?
  stripeSubscriptionId String?
  status               String    @default("active") // active, canceled, past_due, etc.
  currentPeriodStart   DateTime?
  currentPeriodEnd     DateTime?
  lastStripeEventId    String?   // idempotency guard for Stripe webhooks
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
}

model DeoScoreSnapshot {
  id              String   @id @default(cuid())
  project         Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId       String
  overallScore    Int
  contentScore    Int?
  entityScore     Int?
  technicalScore  Int?
  visibilityScore Int?
  version         String   @default("v1")
  metadata        Json?
  computedAt      DateTime @default(now())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([projectId, computedAt(sort: Desc)])
}

model AiUsageEvent {
  id        String   @id @default(cuid())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId String
  feature   String
  createdAt DateTime @default(now())

  @@index([userId, feature, createdAt])
  @@index([projectId, feature, createdAt])
}

model TokenUsage {
  id        String   @id @default(cuid())
  userId    String
  source    String   // e.g. "metadata", "automation:playbook:missing_seo_title"
  amount    Int
  createdAt DateTime @default(now())
}

model AutomationPlaybookDraft {
  id              String                        @id @default(cuid())
  project         Project                       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId       String
  playbookId      String
  scopeId         String
  rulesHash       String
  status          AutomationPlaybookDraftStatus @default(PARTIAL)
  sampleProductIds Json?
  draftItems      Json?
  counts          Json?
  rules           Json?
  createdByUserId String
  createdAt       DateTime                      @default(now())
  updatedAt       DateTime                      @updatedAt
  expiresAt       DateTime?

  @@unique([projectId, playbookId, scopeId, rulesHash])
  @@index([projectId, playbookId, updatedAt(sort: Desc)])
}

model AutomationPlaybookRun {
  id               String                        @id @default(cuid())
  project          Project                       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId        String
  createdBy        User                          @relation(fields: [createdByUserId], references: [id], onDelete: Cascade)
  createdByUserId  String
  playbookId       String
  runType          AutomationPlaybookRunType
  status           AutomationPlaybookRunStatus   @default(QUEUED)
  scopeId          String
  rulesHash        String
  draftId          String?                       // references AutomationPlaybookDraft.id (no FK for v1)
  idempotencyKey   String
  aiUsed           Boolean                       @default(false)
  errorCode        String?
  errorMessage     String?
  resultRef        String?                       // e.g., changeset id or summary key
  meta             Json?
  createdAt        DateTime                      @default(now())
  updatedAt        DateTime                      @updatedAt

  // CACHE/REUSE v2: Deterministic reuse tracking
  aiWorkKey        String?                       // SHA-256 hash of (playbookId, productIds, rules) for AI work deduplication
  reused           Boolean                       @default(false)
  reusedFromRunId  String?                       // references the run whose AI work was reused

  @@index([projectId, createdAt(sort: Desc)])
  @@index([projectId, playbookId, runType, createdAt(sort: Desc)])
  @@index([projectId, scopeId, runType, createdAt(sort: Desc)])
  @@index([projectId, playbookId, runType, aiWorkKey])
  @@unique([projectId, playbookId, runType, scopeId, rulesHash, idempotencyKey])
}

// ============================================================================
// SEARCH-INTENT-1: Search & Intent Pillar Models
// ============================================================================

enum SearchIntentType {
  INFORMATIONAL
  COMPARATIVE
  TRANSACTIONAL
  PROBLEM_USE_CASE
  TRUST_VALIDATION
}

enum IntentCoverageStatus {
  NONE
  WEAK
  PARTIAL
  COVERED
}

enum IntentFixDraftType {
  ANSWER_BLOCK
  CONTENT_SNIPPET
  METADATA_GUIDANCE
}

enum IntentFixApplyTarget {
  ANSWER_BLOCK
  CONTENT_SNIPPET_SECTION
}

// Per-product intent coverage analysis
model ProductIntentCoverage {
  id              String              @id @default(cuid())
  product         Product             @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId       String
  intentType      SearchIntentType
  score           Float               // 0-100 coverage score
  coverageStatus  IntentCoverageStatus
  missingQueries  Json                // string[] of queries with no coverage
  weakQueries     Json                // string[] of queries with weak coverage
  coveredQueries  Json                // string[] of queries with strong coverage
  expectedQueries Json                // string[] of all expected queries for this intent
  computedAt      DateTime            @default(now())
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  @@unique([productId, intentType])
  @@index([productId, computedAt(sort: Desc)])
}

// Draft fixes for intent coverage gaps (preview-first pattern)
model ProductIntentFixDraft {
  id               String              @id @default(cuid())
  product          Product             @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId        String
  intentType       SearchIntentType
  query            String              // The specific query this draft addresses
  draftType        IntentFixDraftType
  draftPayload     Json                // Answer Block structure or content snippet
  aiWorkKey        String              // Deterministic key for CACHE/REUSE v2
  reusedFromWorkKey String?            // If reused, the original work key
  generatedWithAi  Boolean             @default(true)
  expiresAt        DateTime?           // Optional TTL for draft expiry
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt

  applications     ProductIntentFixApplication[]

  @@index([productId, intentType, query])
  @@index([aiWorkKey])
  @@index([productId, expiresAt])
}

// Audit log for applied intent fixes
model ProductIntentFixApplication {
  id              String              @id @default(cuid())
  product         Product             @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId       String
  draft           ProductIntentFixDraft @relation(fields: [draftId], references: [id], onDelete: Cascade)
  draftId         String
  appliedBy       User                @relation(fields: [appliedByUserId], references: [id], onDelete: Cascade)
  appliedByUserId String
  intentType      SearchIntentType
  query           String
  applyTarget     IntentFixApplyTarget
  notes           String?
  appliedAt       DateTime            @default(now())

  @@index([productId, appliedAt(sort: Desc)])
  @@index([appliedByUserId, appliedAt(sort: Desc)])
}

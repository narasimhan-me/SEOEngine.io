#!/usr/bin/env node
/**
 * ICONS-LOCAL-LIBRARY-1 - SVG Sprite Builder
 *
 * Builds sprite.svg from individual SVG files in the svg/ folder.
 * Usage: node scripts/build-material-symbols-sprite.mjs
 *
 * Dev-only script - run after adding new icons to regenerate the sprite.
 * The sprite is committed to the repo (no runtime CDN fetch).
 */

import { readdirSync, readFileSync, writeFileSync } from 'fs';
import { join, basename, dirname } from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

const SVG_DIR = join(__dirname, '../apps/web/public/icons/material-symbols/svg');
const SPRITE_PATH = join(__dirname, '../apps/web/public/icons/material-symbols/sprite.svg');

function extractSvgContent(svgString) {
  // Remove XML declaration and doctype
  let content = svgString
    .replace(/<\?xml[^>]*\?>/gi, '')
    .replace(/<!DOCTYPE[^>]*>/gi, '')
    .trim();

  // Extract the inner content of the SVG (paths, groups, etc.)
  const innerMatch = content.match(/<svg[^>]*>([\s\S]*)<\/svg>/i);
  if (!innerMatch) {
    console.warn('Could not extract SVG inner content');
    return '';
  }

  // Remove any scripts, metadata, defs that are not essential
  let inner = innerMatch[1]
    .replace(/<script[\s\S]*?<\/script>/gi, '')
    .replace(/<metadata[\s\S]*?<\/metadata>/gi, '')
    .replace(/<title[\s\S]*?<\/title>/gi, '')
    .replace(/<desc[\s\S]*?<\/desc>/gi, '')
    .trim();

  // Ensure paths use currentColor for fill/stroke
  inner = inner
    .replace(/fill="[^"]*"/gi, 'fill="currentColor"')
    .replace(/stroke="[^"]*"/gi, '');

  // If no fill attribute exists on paths, add currentColor
  inner = inner.replace(/<path(?![^>]*fill=)/gi, '<path fill="currentColor"');

  return inner;
}

function buildSprite() {
  console.log('Building Material Symbols sprite...');
  console.log(`Source: ${SVG_DIR}`);
  console.log(`Output: ${SPRITE_PATH}`);

  let files;
  try {
    files = readdirSync(SVG_DIR).filter((f) => f.endsWith('.svg'));
  } catch (error) {
    console.error(`Error reading SVG directory: ${error.message}`);
    console.log('Creating empty sprite...');
    files = [];
  }

  if (files.length === 0) {
    console.warn('No SVG files found. Creating placeholder sprite.');
  }

  const symbols = files.map((file) => {
    const id = basename(file, '.svg');
    const content = readFileSync(join(SVG_DIR, file), 'utf-8');
    const inner = extractSvgContent(content);

    return `  <symbol id="${id}" viewBox="0 0 24 24">\n    ${inner}\n  </symbol>`;
  });

  const sprite = `<?xml version="1.0" encoding="UTF-8"?>
<!--
  ICONS-LOCAL-LIBRARY-1 - Material Symbols Sprite
  Generated by build-material-symbols-sprite.mjs
  Do not edit manually - regenerate after adding icons.

  Total icons: ${files.length}
-->
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
${symbols.join('\n')}
</svg>
`;

  writeFileSync(SPRITE_PATH, sprite, 'utf-8');
  console.log(`Sprite built successfully with ${files.length} icons.`);
}

buildSprite();

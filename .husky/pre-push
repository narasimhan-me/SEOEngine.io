echo "ğŸ” Running pre-push checks..."

# Run linting on source files
echo "ğŸ“ Running linter on source files..."
cd apps/api
npx -y pnpm@8.15.9 exec eslint "src/**/*.ts" --fix || {
  echo "âŒ Linting failed. Please fix the errors and try again."
  exit 1
}
cd ../..

# Run formatting check (if prettier is configured)
echo "ğŸ¨ Checking code formatting..."
if command -v prettier >/dev/null 2>&1 || npx -y pnpm@8.15.9 exec prettier --version >/dev/null 2>&1; then
  npx -y pnpm@8.15.9 exec prettier --check "apps/api/src/**/*.ts" "apps/web/src/**/*.{ts,tsx}" || {
    echo "âš ï¸  Code formatting issues found. Run 'pnpm format' to fix."
    # Don't fail on format, just warn
  }
else
  echo "âš ï¸  Prettier not found, skipping format check"
fi

# Run TypeScript type checks
echo "ğŸ”§ Running TypeScript type checks..."
cd apps/api
npx -y pnpm@8.15.9 exec tsc --noEmit || {
  echo "âŒ TypeScript type check failed. Please fix the errors and try again."
  exit 1
}
cd ../..

# Run unit tests
echo "ğŸ§ª Running unit tests..."
npx -y pnpm@8.15.9 test:unit || {
  echo "âŒ Unit tests failed. Please fix the failing tests and try again."
  exit 1
}

# Run all integration tests
echo "ğŸ” Running all integration tests..."
echo "âš ï¸  Note: Integration tests require a test database."
echo "   If tests fail due to database connection, set up the test database:"
echo "   1. Create database: CREATE DATABASE engineo_test;"
echo "   2. Set DATABASE_URL_TEST in apps/api/.env.test"
echo "   3. Run: cd apps/api && pnpm db:test:migrate"
echo ""
NODE_ENV=test ENGINEO_ENV=test npx -y pnpm@8.15.9 test:api || {
  echo ""
  echo "âŒ Integration tests failed."
  echo ""
  echo "If the failure is due to database connection issues:"
  echo "  1. Set up the test database (see apps/api/TEST_DB_SETUP_GUIDE.md)"
  echo "  2. Or skip with: git push --no-verify (not recommended)"
  echo ""
  exit 1
}

echo "âœ… All pre-push checks passed!"


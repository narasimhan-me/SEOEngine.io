# Engine Run Artifacts

PATCH BATCH: AUTONOMOUS-AGENT-AUTOVERIFY-AUTOFIX-LOOP-SAFETY-1

This document describes the artifacts generated by the EngineO Autonomous Execution Engine during auto-verify and auto-fix operations.

## Auto-Verify Artifacts

### Evidence File

**Pattern:** `{STORY_KEY}-evidence-{timestamp}.txt`
**Location:** `reports/` (configurable via `ENGINEO_ARTIFACTS_DIR`)
**Retention:** One file per auto-verify run (timestamped)

Contains redacted output from each executed command, including:
- Command executed
- Item ID (stable hash of checklist content)
- Exit code
- Duration
- Timeout status
- Pass/fail status
- Failure type classification
- Redacted stdout/stderr

### Summary File

**Pattern:** `{STORY_KEY}-auto-verify-summary.json`
**Location:** `reports/` (configurable via `ENGINEO_ARTIFACTS_DIR`)
**Retention:** Overwritten on each auto-verify run

JSON file containing structured summary:
```json
{
  "story_key": "KAN-25",
  "timestamp": "20260128T120000Z",
  "results": [
    {
      "item_id": "abc12345",
      "command": "pnpm type-check",
      "exit_code": 0,
      "duration_seconds": 5.2,
      "timed_out": false,
      "passed": true,
      "failure_type": null
    }
  ],
  "all_passed": true,
  "total_commands": 3,
  "passed_count": 3,
  "failed_count": 0
}
```

## Evidence Markers in Reports

### Marker Pattern

Evidence sub-bullets are inserted below checklist items using a stable marker:
```markdown
- [x] Run type check
  - Auto-verified: PASS (see `KAN-25-evidence-20260128T120000Z.txt`) <!-- AUTO-VERIFY:abc12345 -->
```

### Idempotent Updates

The marker pattern `<!-- AUTO-VERIFY:{item_id} -->` ensures:
- Reruns don't duplicate evidence lines
- Existing evidence is replaced, not appended
- Item ID is stable based on checklist content hash

## Work Ledger Counters

### New Fields (PATCH 3)

| Field | Type | Description |
|-------|------|-------------|
| `auto_verify_runs` | int | Count of auto-verify cycles (bounded by `max_verify_cycles`) |
| `auto_fix_attempts` | int | Count of auto-fix attempts (bounded by `max_auto_fix_attempts`) |
| `last_failure_hash` | string | Hash of last failure (cmd+exit+output) for loop detection |
| `last_failure_type` | string | Classification: CODE_ERROR, TEST_FAILURE, LINT_ERROR, TYPE_ERROR, ENV_ERROR, TIMEOUT, UNKNOWN |
| `last_failure_at` | ISO8601 | When last failure occurred |
| `verify_last_commit_sha` | string | Commit SHA at last verification (for "code changed" bypass) |

### Default Limits

| Limit | Default | Env Override |
|-------|---------|--------------|
| `max_auto_fix_attempts` | 2 | `ENGINEO_MAX_AUTO_FIX_ATTEMPTS` |
| `max_verify_cycles` | 3 | `ENGINEO_MAX_VERIFY_CYCLES` |

### Same Failure Hash Policy

**Invariant:** Same failure hash requires code change before retry.

When a failure occurs:
1. Compute failure hash from: command + exit code + normalized output (first 1000 chars)
2. Compare with `last_failure_hash` in ledger
3. If same AND `verify_last_commit_sha` matches current HEAD → do NOT retry
4. Route to HUMAN ATTENTION NEEDED

This prevents infinite loops on deterministic failures.

## Failure Type Classification

| Type | Indicators |
|------|------------|
| `CODE_ERROR` | General code/compile errors |
| `TEST_FAILURE` | Test suite failures (test failed, assertion error) |
| `LINT_ERROR` | Linting errors (eslint, lint error) |
| `TYPE_ERROR` | TypeScript/type errors (ts error, type error) |
| `ENV_ERROR` | Environment/setup errors (command not found, module not found) |
| `TIMEOUT` | Command timed out |
| `UNKNOWN` | Unclassified failure |

### Auto-Fix Eligibility

NOT eligible for auto-fix:
- `ENV_ERROR` (environment setup issue, not code problem)
- `TIMEOUT` (may be intermittent, needs investigation)

## Human State Routing

### HUMAN TO REVIEW AND CLOSE

Triggered when:
- All automatable checklist items pass
- Manual-only items remain unchecked

**Example Jira comment:**
```
Supervisor Auto-Verify: PARTIAL PASS — manual items remain

Auto-verified items: 3
Manual items remaining: 2

Evidence: `KAN-25-evidence-20260128T120000Z.txt`
Summary: `KAN-25-auto-verify-summary.json`

Story transitioned to HUMAN TO REVIEW AND CLOSE for manual verification.
```

### HUMAN ATTENTION NEEDED

Triggered when:
- Auto-fix attempts exhausted (`auto_fix_attempts >= max_auto_fix_attempts`)
- Auto-verify cycles exhausted (`auto_verify_runs >= max_verify_cycles`)
- Failure type is ENV_ERROR or TIMEOUT (not auto-fixable)
- Same failure hash without code change

**Example Jira comment:**
```
Supervisor Auto-Verify: FAILED — requires human attention

Failed items: 1
Failure type: TYPE_ERROR
Auto-fix attempts: 2/2
Auto-verify cycles: 3/3

Evidence: `KAN-25-evidence-20260128T120000Z.txt`
Summary: `KAN-25-auto-verify-summary.json`

Story transitioned to HUMAN ATTENTION NEEDED.
```

## Configuration

### Enable Auto-Verify

```bash
export ENGINEO_AUTOVERIFY_ENABLED=1
```

### Command Allowlist

```bash
# Default (pnpm build excluded)
export ENGINEO_AUTOVERIFY_ALLOWLIST="pnpm type-check,pnpm lint,pnpm test,pnpm test:e2e"

# Enable build
export ENGINEO_AUTOVERIFY_BUILD_ENABLED=1
```

### Git Push Control

```bash
# Default: disabled (commits are local only)
export ENGINEO_GIT_PUSH_ENABLED=0

# Enable push (use with caution)
export ENGINEO_GIT_PUSH_ENABLED=1
```

**Note:** Auto-verify artifact commits NEVER push regardless of this setting.

## Authoring Automatable Checklist Items

### Explicit AUTO Tag (Preferred)

```markdown
<!-- AUTO:CMD=pnpm type-check -->
- [ ] Run type check
```

The `<!-- AUTO:CMD=... -->` tag on the line immediately preceding a checkbox specifies the command to execute.

### Backtick Fallback

```markdown
- [ ] Run `pnpm lint` to check code style
```

If no AUTO tag is present, the first backticked segment on the checkbox line is used as the command, subject to:
1. Must match an allowlist prefix
2. Must not contain shell metacharacters (`|;&$` etc.)

### Manual Items

```markdown
- [ ] Verify UI renders correctly in all browsers
```

Items without AUTO tags or allowlisted backtick commands are considered manual and require human verification.
